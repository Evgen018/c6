<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <style>
      :root {
        --bg-body: #f5f5f5;
        --bg-calculator: #fff;
        --bg-display: #fafafa;
        --border-display: #d9d9d9;
        --text-primary: #000;
        --btn-number: #e8e8e8;
        --btn-number-hover: #d0d0d0;
        --btn-operator: #ffe6cc;
        --btn-operator-hover: #ffd9b3;
        --btn-control: #ffd6d6;
        --btn-control-hover: #ffc0c0;
        --btn-clear: #ff6b6b;
        --btn-clear-hover: #ff5252;
        --btn-equals: #b7f5a1;
        --btn-equals-hover: #9de585;
        --shadow: rgba(0, 0, 0, 0.15);
      }

      [data-theme="dark"] {
        --bg-body: #1a1a1a;
        --bg-calculator: #2d2d2d;
        --bg-display: #1e1e1e;
        --border-display: #404040;
        --text-primary: #fff;
        --btn-number: #404040;
        --btn-number-hover: #4d4d4d;
        --btn-operator: #ff9500;
        --btn-operator-hover: #ffaa33;
        --btn-control: #505050;
        --btn-control-hover: #606060;
        --btn-clear: #ff4444;
        --btn-clear-hover: #ff6666;
        --btn-equals: #34c759;
        --btn-equals-hover: #30d158;
        --shadow: rgba(0, 0, 0, 0.5);
      }

      * {
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      body {
        margin: 0;
        padding: 24px;
        background: var(--bg-body);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        transition: background-color 0.3s ease;
      }

      .calculator {
        width: 320px;
        background: var(--bg-calculator);
        border-radius: 16px;
        box-shadow: 0 10px 25px var(--shadow);
        padding: 24px;
        position: relative;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }

      .theme-toggle {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--btn-control);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: background-color 0.3s ease, transform 0.2s ease;
        z-index: 10;
      }

      .theme-toggle:hover {
        background: var(--btn-control-hover);
        transform: scale(1.1);
      }

      .theme-toggle:active {
        transform: scale(0.95);
      }

      .display {
        width: 100%;
        height: 64px;
        margin-bottom: 16px;
        padding: 12px;
        border: 2px solid var(--border-display);
        border-radius: 12px;
        text-align: right;
        font-size: 28px;
        background: var(--bg-display);
        color: var(--text-primary);
        overflow: hidden;
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      button {
        height: 56px;
        border: none;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.05s ease, background-color 0.3s ease;
        color: var(--text-primary);
      }

      button:not(.theme-toggle):not(.btn-clear):not(.btn-equals) {
        background: var(--btn-number);
      }

      button:not(.theme-toggle):not(.btn-clear):not(.btn-equals):hover {
        background: var(--btn-number-hover);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .btn-operator {
        background: var(--btn-operator) !important;
      }

      .btn-operator:hover {
        background: var(--btn-operator-hover) !important;
      }

      .btn-control {
        background: var(--btn-control) !important;
      }

      .btn-control:hover {
        background: var(--btn-control-hover) !important;
      }

      .btn-clear {
        background: var(--btn-clear) !important;
        color: #fff !important;
      }

      .btn-clear:hover {
        background: var(--btn-clear-hover) !important;
      }

      .btn-equals {
        background: var(--btn-equals) !important;
        grid-column: span 2;
      }

      .btn-equals:hover {
        background: var(--btn-equals-hover) !important;
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <button class="theme-toggle" id="themeToggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span id="themeIcon">üåô</span>
      </button>
      <div id="display" class="display">0</div>
      <div class="grid">
        <button class="btn-control btn-clear" data-action="clear">C</button>
        <button class="btn-control" data-action="backspace">‚å´</button>
        <button class="btn-control" data-action="sign">¬±</button>
        <button class="btn-operator" data-value="/">√∑</button>

        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button class="btn-operator" data-value="*">√ó</button>

        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button class="btn-operator" data-value="-">‚àí</button>

        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button class="btn-operator" data-value="+">+</button>

        <button class="btn-zero" data-value="0">0</button>
        <button data-value=".">.</button>
        <button class="btn-equals" data-action="equals">=</button>
      </div>
    </div>

    <script>
      (function () {
        const display = document.getElementById("display");
        const grid = document.querySelector(".grid");
        const themeToggle = document.getElementById("themeToggle");
        const themeIcon = document.getElementById("themeIcon");
        let expression = "";

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
        function initTheme() {
          const savedTheme = localStorage.getItem("theme") || "light";
          document.documentElement.setAttribute("data-theme", savedTheme);
          updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
          const currentTheme = document.documentElement.getAttribute("data-theme");
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          document.documentElement.setAttribute("data-theme", newTheme);
          localStorage.setItem("theme", newTheme);
          updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
          themeIcon.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        themeToggle.addEventListener("click", toggleTheme);
        initTheme();

        function updateDisplay(value) {
          display.textContent = value || "0";
        }

        function appendValue(value) {
          // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤–≤–æ–¥ –¥–≤—É—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥
          if (/[+\-*/]$/.test(expression) && /[+\-*/]/.test(value)) {
            expression = expression.slice(0, -1) + value;
          } else {
            expression += value;
          }
          updateDisplay(expression);
        }

        function compute() {
          if (!expression) {
            return;
          }
          try {
            // –ó–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º
            let sanitized = expression
              .replace(/√∑/g, "/")
              .replace(/√ó/g, "*")
              .replace(/‚àí/g, "-")
              .replace(/[^0-9+\-*/.]/g, "");
            const result = Function(`"use strict"; return (${sanitized})`)();
            const resultStr = Number.isFinite(result) ? result.toString() : "–û—à–∏–±–∫–∞";
            expression = resultStr;
            console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç:", resultStr);
            updateDisplay(resultStr);
          } catch (err) {
            expression = "";
            console.log("–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:", err);
            updateDisplay("–û—à–∏–±–∫–∞");
          }
        }

        grid.addEventListener("click", (event) => {
          const target = event.target;
          if (target.tagName !== "BUTTON") {
            return;
          }

          const { value } = target.dataset;
          const action = target.dataset.action;

          if (value) {
            appendValue(value);
            return;
          }

          switch (action) {
            case "clear":
              expression = "";
              updateDisplay("");
              break;
            case "backspace":
              expression = expression.slice(0, -1);
              updateDisplay(expression);
              break;
            case "sign":
              if (!expression) {
                return;
              }
              try {
                const lastNumberMatch = expression.match(/(-?\d+\.?\d*)$/);
                if (!lastNumberMatch) {
                  return;
                }
                const lastNumber = lastNumberMatch[0];
                const toggled =
                  lastNumber.startsWith("-") ?
                    lastNumber.slice(1) :
                    "-" + lastNumber;
                expression =
                  expression.slice(0, -lastNumber.length) + toggled;
                updateDisplay(expression);
              } catch (_err) {
                updateDisplay("–û—à–∏–±–∫–∞");
              }
              break;
            case "equals":
              compute();
              break;
            default:
              break;
          }
        });

        document.addEventListener("keydown", (event) => {
          const key = event.key;
          if (/^[0-9.+\-*/]$/.test(key)) {
            appendValue(key);
          } else if (key === "Enter" || key === "=") {
            event.preventDefault();
            compute();
          } else if (key === "Backspace") {
            expression = expression.slice(0, -1);
            updateDisplay(expression);
          } else if (key === "Escape") {
            expression = "";
            updateDisplay("");
          }
        });
      })();
    </script>
  </body>
</html>

